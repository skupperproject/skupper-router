#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#



== qdrouterd shutdown procedure


How does the router shut down when interrupted with ctrl-C ?


. ctrl-c is caught by server.c::handle().
  it comes packaged by proton as PN_PROACTOR_INTERRUPT.
  handle() sends it back through proton 
  with pn_proactor_interrupt()
  to interrupt the next thread, and then returns false.


. The false return from handle() is received by thread_run().
  If there is a container, thread_run() calls 
  qd_conn_event_batch_complete() to let the container know 
  that the work batch is finished.

.. qd_conn_event_batch_complete() loops through the 
   free_link_session_list for this container. 
   If the connection is not already closed, it frees 
   each session's pn_link and pn_session, if they exist.


. Once all threads have exited from thread_run(), 
  qd_server_run() logs a "Shut Down" message, and returns to 
  main_process() in main.c .


. main_process() sets to NULL the dispatch pointer that 
  everybody was using, and then frees the structure.


. main_process() flushes stdout.


. If the router kill was caused by a SIGINT, main_process()
  cancels its handler of that signal, and then sends the 
  signal to itself, ending the process.
  If there was no SIGINT, it just exits, ending the process.


. Silence descends, like the falling snow.



